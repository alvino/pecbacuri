{% extends "base.html" %}
{% load humanize %} 

{% block title %}Relatório de Desempenho por Pasto{% endblock %}

{% block content %}
    <h1 class="mb-4">Relatório de Desempenho por Pasto</h1>
    <p class="lead">Análise de GPMD e Custos do lote no período selecionado.</p>

    <form method="get" class="row g-3 align-items-end mb-5 bg-light p-3 rounded shadow-sm">
        <div class="col-md-4">
            <label for="pasto" class="form-label">Selecione o Pasto</label>
            <select class="form-select" id="pasto" name="pasto" required>
                <option value="">--- Selecione ---</option>
                {% for p in pastos %}
                    <option value="{{ p.pk }}" {% if p.pk|stringformat:"s" == request.GET.pasto %}selected{% endif %}>
                        {{ p.nome }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="data_inicio" class="form-label">Data Início</label>
            <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ data_inicio_filtro }}">
        </div>
        <div class="col-md-3">
            <label for="data_fim" class="form-label">Data Fim</label>
            <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ data_fim_filtro }}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Gerar Relatório</button>
        </div>
    </form>
    
    {% if relatorio_resumo %}
        
        <h2 class="mb-4">Desempenho do Lote: {{ relatorio_resumo.pasto_nome }}</h2>

        <div class="row g-4 mb-5">
            <div class="col-lg-4">
                <div class="card h-100 border-success">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">GPMD Médio do Lote (Kg/dia)</h6>
                        <h5 class="card-title fs-3 fw-bold">{{ relatorio_resumo.media_gpmd_lote|floatformat:3 }}</h5>
                        <small>Total de animais analisados: {{ relatorio_resumo.total_animais }}</small>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card h-100 border-danger">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Custo Total do Lote (R$)</h6>
                        <h5 class="card-title fs-3 fw-bold">R$ {{ relatorio_resumo.custo_total_lote|floatformat:2|intcomma }}</h5>
                        <small>Alocação de custos no período</small>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card h-100 border-warning">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Custo Médio por Animal (R$)</h6>
                        <h5 class="card-title fs-3 fw-bold">R$ {{ relatorio_resumo.custo_medio_animal|floatformat:2 }}</h5>
                        <small>Custo total dividido pelo n° de animais</small>
                    </div>
                </div>
            </div>
        </div>

        <h3 class="mt-5 mb-3">Desempenho Individual no Pasto</h3>
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Identificação</th>
                    <th class="text-end">Peso Recente (Kg)</th>
                    <th class="text-end">GPMD Médio (Kg/dia)</th>
                    <th class="text-end">Custo Alocado (R$)</th>
                </tr>
            </thead>
            <tbody>
                {% for animal in animais_desempenho %}
                <tr>
                    <td><a href="{% url 'animal_detail' pk=animal.identificacao %}">{{ animal.identificacao }}</a></td>
                    <td class="text-end">{{ animal.peso_atual|floatformat:2|default:"N/A" }}</td>
                    <td class="text-end">
                        {% if animal.gpmd_medio > relatorio_resumo.media_gpmd_lote %}
                            <span class="text-success fw-bold">{{ animal.gpmd_medio|floatformat:3 }} ↑</span>
                        {% else %}
                            <span class="text-danger">{{ animal.gpmd_medio|floatformat:3 }} ↓</span>
                        {% endif %}
                    </td>
                    <td class="text-end">{{ animal.custo_periodo|floatformat:2|intcomma }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4">Nenhum animal com dados de pesagem/custo no período.</td></tr>
                {% endfor %}
            </tbody>
        </table>

    {% elif request.GET.pasto %}
        <div class="alert alert-info">
            Nenhum animal com dados de desempenho e custo encontrados para o Pasto selecionado no período.
        </div>
    {% else %}
        <div class="alert alert-primary">
            Por favor, selecione um Pasto e um Período para gerar o relatório de desempenho.
        </div>
    {% endif %}

{% endblock content %}
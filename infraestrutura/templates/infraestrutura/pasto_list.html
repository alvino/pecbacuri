{% extends "base.html" %}

{% load custom_filters %}

{% block title %}Controle de Pastos e Lotação{% endblock %}

{% block content %}
    <h1 class="mb-4">Controle de Pastos</h1>
    <p class="lead">Visão geral da lotação e do status de todas as áreas da fazenda.</p>
    
    <a href="{% url 'pasto_create' %}" class="btn btn-primary mb-4">Cadastrar Novo Pasto</a>

    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Pasto</th>
                
                <th class="text-center">Animais Atuais</th>
                <th class="text-center">Lotação</th>
                <th>Detalhes</th>
            </tr>
        </thead>
        <tbody>
            {% for pasto in pastos %}
            {# O método get_total_animais é chamado no modelo Pasto para contar os animais no pasto_atual #}
            {% with total_animais=pasto.get_total_animais %}
            <tr>
                <td>
                    <a href="{% url 'pasto_detail' pk=pasto.pk %}">
                        <strong>{{ pasto.nome }}</strong>
                    </a>
                </td>
                <td class="text-center">{{ pasto.capacidade_maxima_ua }}</td>
                <td class="text-center">
                    <span class="badge bg-secondary">{{ total_animais }}</span>
                </td>
                <td class="text-center">
                    {% if pasto.capacidade_maxima_ua > 0 %}
                        {% if total_animais > pasto.capacidade_maxima_ua %}
                            <span class="badge bg-danger">LOTADO ({{ total_animais|sub:pasto.capacidade_maxima_ua }} acima)</span>
                        {% elif total_animais > pasto.capacidade_maxima_ua|mul:"0.8" %}
                            <span class="badge bg-warning">Próximo do Limite</span>
                        {% elif total_animais == 0 %}
                            <span class="badge bg-success">Livre</span>
                        {% else %}
                            <span class="badge bg-info">Normal</span>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-secondary">Capacidade N/A</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'pasto_detail' pk=pasto.pk %}" class="btn btn-sm btn-outline-info">
                        Ver Animais
                    </a>
                </td>
            </tr>
            {% endwith %}
            {% empty %}
            <tr>
                <td colspan="5" class="text-center">
                    Nenhum pasto cadastrado. <a href="{% url 'admin:ControleRebanho_pasto_add' %}">Adicionar Pasto</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="mt-5">
        <h3 class="mb-3">Registro de Movimentações</h3>
        <p>Use esta área para registrar a entrada e saída dos animais entre os pastos.</p>
        <a href="{% url 'movimentar_animais' %}" class="btn btn-warning">
            Registrar Nova Movimentação
        </a>
    </div>
    
{% endblock content %}